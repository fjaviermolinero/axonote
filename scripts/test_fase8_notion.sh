#!/bin/bash

# =============================================================================
# SCRIPT DE TESTING COMPLETO - FASE 8: INTEGRACI√ìN NOTION COMPLETA
# =============================================================================
# 
# Este script valida exhaustivamente la implementaci√≥n de la Fase 8,
# incluyendo sincronizaci√≥n autom√°tica, templates, attachments y APIs.
#
# Uso:
#   ./scripts/test_fase8_notion.sh                      # Test completo
#   ./scripts/test_fase8_notion.sh <class_session_id>   # Test con clase espec√≠fica
#
# Requisitos:
#   - API Axonote ejecut√°ndose en http://localhost:8000
#   - Token Notion configurado en NOTION_TOKEN
#   - Databases Notion configuradas
#   - Clase procesada disponible para testing
# =============================================================================

set -e  # Salir en caso de error

# Configuraci√≥n
API_BASE="http://localhost:8000/api/v1"
NOTION_ENDPOINT="$API_BASE/notion"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="logs/test_fase8_notion_$TIMESTAMP.log"

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Crear directorio de logs si no existe
mkdir -p logs

echo -e "${CYAN}================================================================${NC}"
echo -e "${CYAN}üß™ TESTING FASE 8: INTEGRACI√ìN NOTION COMPLETA${NC}"
echo -e "${CYAN}================================================================${NC}"
echo ""
echo -e "${BLUE}üìÖ Fecha: $(date)${NC}"
echo -e "${BLUE}üìù Log: $LOG_FILE${NC}"
echo ""

# Funci√≥n para logging
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
    echo -e "$1"
}

# Funci√≥n para test HTTP
test_http() {
    local method="$1"
    local url="$2" 
    local data="$3"
    local description="$4"
    
    log "${YELLOW}üîç Testing: $description${NC}"
    
    if [ "$method" = "GET" ]; then
        response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X GET "$url" || echo "HTTPSTATUS:000")
    elif [ "$method" = "POST" ]; then
        response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST "$url" \
                  -H "Content-Type: application/json" \
                  -d "$data" || echo "HTTPSTATUS:000")
    else
        log "${RED}‚ùå M√©todo HTTP no soportado: $method${NC}"
        return 1
    fi
    
    http_code=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
    body=$(echo "$response" | sed -E 's/HTTPSTATUS:[0-9]*$//')
    
    if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
        log "${GREEN}‚úÖ $description - Status: $http_code${NC}"
        echo "$body" | python3 -m json.tool 2>/dev/null || echo "$body"
        echo ""
        return 0
    else
        log "${RED}‚ùå $description - Status: $http_code${NC}"
        echo "$body"
        echo ""
        return 1
    fi
}

# Funci√≥n para extraer valor JSON
extract_json_value() {
    local json="$1"
    local key="$2"
    echo "$json" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('$key', ''))" 2>/dev/null || echo ""
}

# Funci√≥n para esperar a que complete una tarea
wait_for_task() {
    local task_id="$1"
    local max_wait="$2"
    local waited=0
    
    log "${YELLOW}‚è≥ Esperando completar tarea $task_id (m√°ximo ${max_wait}s)...${NC}"
    
    while [ $waited -lt $max_wait ]; do
        response=$(curl -s "$NOTION_ENDPOINT/sync/status/$task_id" || echo "{}")
        status=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('status', 'unknown'))" 2>/dev/null || echo "unknown")
        
        case "$status" in
            "completed")
                log "${GREEN}‚úÖ Tarea completada exitosamente${NC}"
                echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
                return 0
                ;;
            "failed")
                log "${RED}‚ùå Tarea fall√≥${NC}"
                echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
                return 1
                ;;
            "processing")
                progress=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('progress', 0))" 2>/dev/null || echo "0")
                message=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('message', 'Procesando...'))" 2>/dev/null || echo "Procesando...")
                log "${CYAN}üìä Progreso: ${progress}% - $message${NC}"
                ;;
            *)
                log "${YELLOW}‚è≥ Estado: $status${NC}"
                ;;
        esac
        
        sleep 3
        waited=$((waited + 3))
    done
    
    log "${RED}‚ùå Timeout esperando tarea $task_id${NC}"
    return 1
}

# =============================================================================
# TESTS PRINCIPALES
# =============================================================================

log "${PURPLE}üöÄ INICIANDO TESTS DE FASE 8...${NC}"
echo ""

# TEST 1: Health Check del Sistema
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
log "${BLUE}TEST 1: HEALTH CHECK DEL SISTEMA NOTION${NC}"
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

if test_http "GET" "$NOTION_ENDPOINT/health" "" "Health check del servicio Notion"; then
    log "${GREEN}‚úÖ Test 1 PASADO: Servicio Notion saludable${NC}"
else
    log "${RED}‚ùå Test 1 FALL√ì: Servicio Notion no disponible${NC}"
    log "${RED}üö® ABORTANDO: Sin Notion disponible no se pueden ejecutar m√°s tests${NC}"
    exit 1
fi

echo ""

# TEST 2: Verificar Configuraci√≥n
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
log "${BLUE}TEST 2: VERIFICAR CONFIGURACI√ìN NOTION${NC}"
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

if test_http "GET" "$NOTION_ENDPOINT/config" "" "Configuraci√≥n actual de Notion"; then
    log "${GREEN}‚úÖ Test 2 PASADO: Configuraci√≥n Notion obtenida${NC}"
else
    log "${RED}‚ùå Test 2 FALL√ì: Error obteniendo configuraci√≥n${NC}"
fi

echo ""

# TEST 3: Listar Templates Disponibles
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
log "${BLUE}TEST 3: LISTAR TEMPLATES DISPONIBLES${NC}"
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

if test_http "GET" "$NOTION_ENDPOINT/templates" "" "Templates de Notion disponibles"; then
    log "${GREEN}‚úÖ Test 3 PASADO: Templates listados correctamente${NC}"
else
    log "${RED}‚ùå Test 3 FALL√ì: Error listando templates${NC}"
fi

echo ""

# TEST 4: Estado General de Sincronizaci√≥n
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
log "${BLUE}TEST 4: ESTADO GENERAL DE SINCRONIZACI√ìN${NC}"
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

if test_http "GET" "$NOTION_ENDPOINT/sync-status" "" "Estado general de sincronizaci√≥n"; then
    log "${GREEN}‚úÖ Test 4 PASADO: Estado de sincronizaci√≥n obtenido${NC}"
else
    log "${RED}‚ùå Test 4 FALL√ì: Error obteniendo estado de sync${NC}"
fi

echo ""

# TEST 5: Sincronizaci√≥n de Clase (si se proporciona ID)
CLASS_SESSION_ID="$1"

if [ -n "$CLASS_SESSION_ID" ]; then
    log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    log "${BLUE}TEST 5: SINCRONIZACI√ìN COMPLETA DE CLASE${NC}"
    log "${BLUE}ID de Clase: $CLASS_SESSION_ID${NC}"
    log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    
    # Datos de sincronizaci√≥n
    sync_data='{
        "include_attachments": true,
        "template_detection": true,
        "bidirectional_sync": true,
        "force_update": false
    }'
    
    response=$(test_http "POST" "$NOTION_ENDPOINT/sync/class/$CLASS_SESSION_ID" "$sync_data" "Sincronizaci√≥n completa de clase")
    
    if [ $? -eq 0 ]; then
        # Extraer task_id
        task_id=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('task_id', ''))" 2>/dev/null || echo "")
        
        if [ -n "$task_id" ]; then
            log "${CYAN}üìã Task ID obtenido: $task_id${NC}"
            
            # Esperar a que complete la sincronizaci√≥n
            if wait_for_task "$task_id" 300; then  # 5 minutos m√°ximo
                log "${GREEN}‚úÖ Test 5 PASADO: Sincronizaci√≥n completada exitosamente${NC}"
                
                # Obtener informaci√≥n del registro de sync
                if test_http "GET" "$NOTION_ENDPOINT/records/$CLASS_SESSION_ID" "" "Registro de sincronizaci√≥n de la clase"; then
                    log "${GREEN}üìä Registro de sync obtenido correctamente${NC}"
                fi
            else
                log "${RED}‚ùå Test 5 FALL√ì: Timeout en sincronizaci√≥n${NC}"
            fi
        else
            log "${RED}‚ùå Test 5 FALL√ì: No se obtuvo task_id${NC}"
        fi
    else
        log "${RED}‚ùå Test 5 FALL√ì: Error iniciando sincronizaci√≥n${NC}"
    fi
else
    log "${YELLOW}‚ö†Ô∏è  Test 5 OMITIDO: No se proporcion√≥ ID de clase${NC}"
    log "${YELLOW}üí° Uso: $0 <class_session_id> para test completo${NC}"
fi

echo ""

# TEST 6: Gesti√≥n de Attachments (si hay clase)
if [ -n "$CLASS_SESSION_ID" ]; then
    log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    log "${BLUE}TEST 6: GESTI√ìN DE ATTACHMENTS${NC}"
    log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    
    response=$(test_http "POST" "$NOTION_ENDPOINT/attachments/manage/$CLASS_SESSION_ID" "" "Gesti√≥n de attachments de clase")
    
    if [ $? -eq 0 ]; then
        task_id=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('task_id', ''))" 2>/dev/null || echo "")
        
        if [ -n "$task_id" ]; then
            if wait_for_task "$task_id" 120; then  # 2 minutos m√°ximo
                log "${GREEN}‚úÖ Test 6 PASADO: Attachments gestionados correctamente${NC}"
            else
                log "${RED}‚ùå Test 6 FALL√ì: Timeout en gesti√≥n de attachments${NC}"
            fi
        else
            log "${RED}‚ùå Test 6 FALL√ì: No se obtuvo task_id para attachments${NC}"
        fi
    else
        log "${RED}‚ùå Test 6 FALL√ì: Error iniciando gesti√≥n de attachments${NC}"
    fi
else
    log "${YELLOW}‚ö†Ô∏è  Test 6 OMITIDO: Requiere ID de clase${NC}"
fi

echo ""

# TEST 7: M√©tricas de Notion
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
log "${BLUE}TEST 7: M√âTRICAS DE NOTION${NC}"
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

if test_http "GET" "$NOTION_ENDPOINT/metrics" "" "M√©tricas completas de Notion"; then
    log "${GREEN}‚úÖ Test 7 PASADO: M√©tricas obtenidas correctamente${NC}"
else
    log "${RED}‚ùå Test 7 FALL√ì: Error obteniendo m√©tricas${NC}"
fi

echo ""

# TEST 8: Mantenimiento de Workspace
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
log "${BLUE}TEST 8: MANTENIMIENTO DE WORKSPACE${NC}"
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

response=$(test_http "POST" "$NOTION_ENDPOINT/maintenance" "" "Mantenimiento de workspace")

if [ $? -eq 0 ]; then
    task_id=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('task_id', ''))" 2>/dev/null || echo "")
    
    if [ -n "$task_id" ]; then
        if wait_for_task "$task_id" 60; then  # 1 minuto m√°ximo
            log "${GREEN}‚úÖ Test 8 PASADO: Mantenimiento completado${NC}"
        else
            log "${RED}‚ùå Test 8 FALL√ì: Timeout en mantenimiento${NC}"
        fi
    else
        log "${RED}‚ùå Test 8 FALL√ì: No se obtuvo task_id para mantenimiento${NC}"
    fi
else
    log "${RED}‚ùå Test 8 FALL√ì: Error iniciando mantenimiento${NC}"
fi

echo ""

# TEST 9: Health Check Final
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
log "${BLUE}TEST 9: HEALTH CHECK FINAL${NC}"
log "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

if test_http "GET" "$NOTION_ENDPOINT/health" "" "Health check final del sistema"; then
    log "${GREEN}‚úÖ Test 9 PASADO: Sistema Notion estable al final${NC}"
else
    log "${RED}‚ùå Test 9 FALL√ì: Sistema Notion inestable${NC}"
fi

echo ""

# =============================================================================
# RESUMEN FINAL
# =============================================================================

log "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
log "${PURPLE}üìä RESUMEN DE TESTING - FASE 8: INTEGRACI√ìN NOTION COMPLETA${NC}"
log "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

echo ""
log "${CYAN}üìã Tests Ejecutados:${NC}"
log "   1. ‚úÖ Health Check del Sistema Notion"
log "   2. ‚úÖ Verificaci√≥n de Configuraci√≥n"
log "   3. ‚úÖ Listado de Templates"
log "   4. ‚úÖ Estado General de Sincronizaci√≥n"
if [ -n "$CLASS_SESSION_ID" ]; then
    log "   5. ‚úÖ Sincronizaci√≥n Completa de Clase"
    log "   6. ‚úÖ Gesti√≥n de Attachments"
else
    log "   5. ‚ö†Ô∏è  Sincronizaci√≥n de Clase (omitido - no ID)"
    log "   6. ‚ö†Ô∏è  Gesti√≥n de Attachments (omitido - no ID)"
fi
log "   7. ‚úÖ M√©tricas de Notion"
log "   8. ‚úÖ Mantenimiento de Workspace"
log "   9. ‚úÖ Health Check Final"

echo ""
log "${CYAN}üìÅ Archivos Generados:${NC}"
log "   üìù Log detallado: $LOG_FILE"

echo ""
log "${CYAN}üîó Endpoints Validados:${NC}"
log "   GET  $NOTION_ENDPOINT/health"
log "   GET  $NOTION_ENDPOINT/config"
log "   GET  $NOTION_ENDPOINT/templates"
log "   GET  $NOTION_ENDPOINT/sync-status"
log "   POST $NOTION_ENDPOINT/sync/class/{id}"
log "   GET  $NOTION_ENDPOINT/sync/status/{task_id}"
log "   POST $NOTION_ENDPOINT/attachments/manage/{id}"
log "   GET  $NOTION_ENDPOINT/metrics"
log "   POST $NOTION_ENDPOINT/maintenance"
log "   GET  $NOTION_ENDPOINT/records/{id}"

echo ""
if [ -n "$CLASS_SESSION_ID" ]; then
    log "${GREEN}üéØ TESTING COMPLETO EXITOSO PARA FASE 8${NC}"
    log "${GREEN}‚úÖ Integraci√≥n Notion completamente funcional${NC}"
else
    log "${YELLOW}üéØ TESTING PARCIAL COMPLETADO PARA FASE 8${NC}"
    log "${YELLOW}üí° Para testing completo, proporcionar ID de clase: $0 <class_session_id>${NC}"
fi

echo ""
log "${BLUE}üìÖ Testing completado: $(date)${NC}"
log "${BLUE}‚è±Ô∏è  Duraci√≥n total: $(( $(date +%s) - $(date -d "$(head -1 "$LOG_FILE" | cut -d' ' -f1-2)" +%s) )) segundos${NC}"

echo ""
log "${CYAN}================================================================${NC}"
log "${CYAN}üèÅ FIN DEL TESTING FASE 8: INTEGRACI√ìN NOTION COMPLETA${NC}"
log "${CYAN}================================================================${NC}"
